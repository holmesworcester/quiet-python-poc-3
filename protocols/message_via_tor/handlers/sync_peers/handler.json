{
  "type": "sync_peers",
  "projector": {
    "description": "Validates sync request and sends all peer events to requester",
    "func": "projector.project",
    "tests": [
      {
        "given": {
          "db": {
            "state": {
              "peers": [
                {"pubkey": "peer1", "name": "Alice"},
                {"pubkey": "peer2", "name": "Bob"}
              ]
            },
            "eventStore": {
              "peer1": [{"type": "peer", "pubkey": "peer1", "name": "Alice"}],
              "peer2": [{"type": "peer", "pubkey": "peer2", "name": "Bob"}]
            }
          },
          "envelope": {
            "recipient": "identity1",
            "data": {
              "type": "sync_peers",
              "sender": "peer3"
            },
            "metadata": {}
          }
        },
        "then": {
          "db": {
            "state": {
              "peers": [
                {"pubkey": "peer1", "name": "Alice"},
                {"pubkey": "peer2", "name": "Bob"}
              ],
              "outgoing": [
                {
                  "recipient": "peer3",
                  "data": {"type": "peer", "pubkey": "peer1", "name": "Alice"}
                },
                {
                  "recipient": "peer3", 
                  "data": {"type": "peer", "pubkey": "peer2", "name": "Bob"}
                }
              ]
            },
            "eventStore": {
              "peer1": [{"type": "peer", "pubkey": "peer1", "name": "Alice"}],
              "peer2": [{"type": "peer", "pubkey": "peer2", "name": "Bob"}],
              "sync-peers-peer3": [{"type": "sync_peers", "sender": "peer3"}]
            }
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Creates a sync-request event given a sender peer",
      "func": "create.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {"sender": "peer1"}
          },
          "then": {
            "return": {
              "return": "Sync request created",
              "newEvents": [
                {"type": "sync_peers", "sender": "peer1"}
              ]
            }
          }
        }
      ]
    },
    "send": {
      "description": "Sends a sync-request to a recipient peer via outgoing",
      "func": "send.execute",
      "tests": [
        {
          "given": {
            "db": {"state": {}},
            "params": {"recipient": "peer2"}
          },
          "then": {
            "return": {
              "return": "Sync request sent to peer2"
            },
            "db": {
              "state": {
                "outgoing": [
                  {
                    "recipient": "peer2",
                    "data": {"type": "sync_peers", "sender": "*"}
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "sync_all": {
      "description": "Sends sync requests from all identities to all their known peers",
      "func": "sync_all.execute",
      "tests": [
        {
          "given": {
            "db": {
              "state": {
                "identities": [
                  {"pubkey": "id1", "name": "Identity1"},
                  {"pubkey": "id2", "name": "Identity2"}
                ],
                "peers": [
                  {"pubkey": "peer1", "name": "Peer1"},
                  {"pubkey": "peer2", "name": "Peer2"}
                ]
              }
            },
            "params": {}
          },
          "then": {
            "return": {
              "return": "Sent sync requests from 2 identities to 2 peers"
            },
            "db": {
              "state": {
                "identities": [
                  {"pubkey": "id1", "name": "Identity1"},
                  {"pubkey": "id2", "name": "Identity2"}
                ],
                "peers": [
                  {"pubkey": "peer1", "name": "Peer1"},
                  {"pubkey": "peer2", "name": "Peer2"}
                ],
                "outgoing": [
                  {
                    "recipient": "peer1",
                    "data": {"type": "sync_peers", "sender": "id1"}
                  },
                  {
                    "recipient": "peer2",
                    "data": {"type": "sync_peers", "sender": "id1"}
                  },
                  {
                    "recipient": "peer1",
                    "data": {"type": "sync_peers", "sender": "id2"}
                  },
                  {
                    "recipient": "peer2",
                    "data": {"type": "sync_peers", "sender": "id2"}
                  }
                ]
              }
            }
          }
        }
      ]
    }
  },
  "job": "sync_all",
  "multi_tick_tests": [
    {
      "description": "Test full peer syncing flow between two identities",
      "ticks": [
        {
          "given": {
            "db": {
              "state": {
                "identities": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"}
                ],
                "peers": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"}
                ],
                "messages": [
                  {"sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000},
                  {"sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000}
                ]
              },
              "eventStore": {
                "alice": [
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "message", "sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000}
                ],
                "bob": [
                  {"type": "peer", "pubkey": "bob", "name": "Bob"},
                  {"type": "message", "sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000}
                ]
              }
            }
          },
          "handlers": ["sync_peers", "tor_simulator"],
          "then": {
            "db": {
              "state": {
                "outgoing": [],
                "incoming": [
                  {
                    "recipient": "alice",
                    "data": {"type": "sync_peers", "sender": "bob"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "sync_peers", "sender": "alice"}
                  }
                ]
              }
            }
          }
        },
        {
          "given": {},
          "handlers": ["incoming", "sync_peers", "tor_simulator"],
          "then": {
            "db": {
              "state": {
                "outgoing": [],
                "incoming": [
                  {
                    "recipient": "bob",
                    "data": {"type": "peer", "pubkey": "alice", "name": "Alice"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "message", "sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000}
                  },
                  {
                    "recipient": "alice",
                    "data": {"type": "peer", "pubkey": "bob", "name": "Bob"}
                  },
                  {
                    "recipient": "alice",
                    "data": {"type": "message", "sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000}
                  }
                ]
              }
            }
          }
        },
        {
          "given": {},
          "handlers": ["incoming", "peer", "message"],
          "then": {
            "db": {
              "state": {
                "peers": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"}
                ],
                "messages": [
                  {"sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000},
                  {"sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000}
                ]
              },
              "eventStore": {
                "alice": [
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "message", "sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000},
                  {"type": "peer", "pubkey": "bob", "name": "Bob"},
                  {"type": "message", "sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000}
                ],
                "bob": [
                  {"type": "peer", "pubkey": "bob", "name": "Bob"},
                  {"type": "message", "sender": "bob", "recipient": "alice", "text": "Hi Alice!", "timestamp": 2000},
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "message", "sender": "alice", "recipient": "bob", "text": "Hello Bob!", "timestamp": 1000}
                ]
              }
            }
          }
        }
      ]
    },
    {
      "description": "Test three-way peer syncing with Charlie joining late",
      "ticks": [
        {
          "given": {
            "db": {
              "state": {
                "identities": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"}
                ],
                "peers": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"}
                ]
              },
              "eventStore": {
                "alice": [{"type": "peer", "pubkey": "alice", "name": "Alice"}],
                "bob": [{"type": "peer", "pubkey": "bob", "name": "Bob"}]
              }
            }
          },
          "handlers": ["sync_peers", "tor_simulator"],
          "then": {
            "db": {
              "state": {
                "incoming": [
                  {
                    "recipient": "alice",
                    "data": {"type": "sync_peers", "sender": "bob"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "sync_peers", "sender": "alice"}
                  }
                ]
              }
            }
          }
        },
        {
          "given": {
            "db": {
              "state": {
                "identities": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"},
                  {"pubkey": "charlie", "name": "Charlie"}
                ],
                "peers": [
                  {"pubkey": "alice", "name": "Alice"},
                  {"pubkey": "bob", "name": "Bob"},
                  {"pubkey": "charlie", "name": "Charlie"}
                ]
              },
              "eventStore": {
                "charlie": [{"type": "peer", "pubkey": "charlie", "name": "Charlie"}]
              }
            }
          },
          "handlers": ["incoming", "sync_peers", "tor_simulator"],
          "then": {
            "db": {
              "state": {
                "incoming": [
                  {
                    "recipient": "alice",
                    "data": {"type": "sync_peers", "sender": "charlie"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "sync_peers", "sender": "charlie"}
                  },
                  {
                    "recipient": "charlie",
                    "data": {"type": "sync_peers", "sender": "alice"}
                  },
                  {
                    "recipient": "charlie",
                    "data": {"type": "sync_peers", "sender": "bob"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "peer", "pubkey": "alice", "name": "Alice"}
                  },
                  {
                    "recipient": "alice",
                    "data": {"type": "peer", "pubkey": "bob", "name": "Bob"}
                  }
                ]
              }
            }
          }
        },
        {
          "given": {},
          "handlers": ["incoming", "sync_peers", "tor_simulator"],
          "then": {
            "db": {
              "state": {
                "incoming": [
                  {
                    "recipient": "charlie",
                    "data": {"type": "peer", "pubkey": "alice", "name": "Alice"}
                  },
                  {
                    "recipient": "charlie",
                    "data": {"type": "peer", "pubkey": "bob", "name": "Bob"}
                  },
                  {
                    "recipient": "alice",
                    "data": {"type": "peer", "pubkey": "charlie", "name": "Charlie"}
                  },
                  {
                    "recipient": "bob",
                    "data": {"type": "peer", "pubkey": "charlie", "name": "Charlie"}
                  }
                ]
              }
            }
          }
        },
        {
          "given": {},
          "handlers": ["incoming", "peer"],
          "then": {
            "db": {
              "eventStore": {
                "alice": [
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "peer", "pubkey": "bob", "name": "Bob"},
                  {"type": "peer", "pubkey": "charlie", "name": "Charlie"}
                ],
                "bob": [
                  {"type": "peer", "pubkey": "bob", "name": "Bob"},
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "peer", "pubkey": "charlie", "name": "Charlie"}
                ],
                "charlie": [
                  {"type": "peer", "pubkey": "charlie", "name": "Charlie"},
                  {"type": "peer", "pubkey": "alice", "name": "Alice"},
                  {"type": "peer", "pubkey": "bob", "name": "Bob"}
                ]
              }
            }
          }
        }
      ]
    }
  ]
}