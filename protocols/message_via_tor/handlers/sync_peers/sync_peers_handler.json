{
  "type": "sync_peers",
  "projector": {
    "description": "Validates sync request and sends all peer events to requester",
    "func": "projector.project",
    "tests": [
      {
        "given": {
          "db": {
            "state": {
              "peers": [
                {
                  "pubkey": "peer1",
                  "name": "Alice",
                  "received_by": "identity1"
                },
                {
                  "pubkey": "peer2",
                  "name": "Bob",
                  "received_by": "identity1"
                }
              ]
            },
            "eventStore": [
              {
                "data": {
                  "type": "peer",
                  "pubkey": "peer1",
                  "name": "Alice"
                },
                "metadata": {
                  "selfGenerated": true,
                  "received_by": "identity1"
                }
              },
              {
                "data": {
                  "type": "peer",
                  "pubkey": "peer2",
                  "name": "Bob"
                },
                "metadata": {
                  "selfGenerated": true,
                  "received_by": "identity1"
                }
              }
            ]
          },
          "envelope": {
            "recipient": "identity1",
            "data": {
              "type": "sync_peers",
              "sender": "peer3"
            },
            "metadata": {
              "received_by": "identity1"
            }
          }
        },
        "then": {
          "db": {
            "state": {
              "peers": [
                {
                  "pubkey": "peer1",
                  "name": "Alice",
                  "received_by": "identity1"
                },
                {
                  "pubkey": "peer2",
                  "name": "Bob",
                  "received_by": "identity1"
                }
              ],
              "outgoing": [
                {
                  "recipient": "peer3",
                  "data": {
                    "type": "peer",
                    "pubkey": "peer1",
                    "name": "Alice"
                  }
                },
                {
                  "recipient": "peer3",
                  "data": {
                    "type": "peer",
                    "pubkey": "peer2",
                    "name": "Bob"
                  }
                }
              ]
            }
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Creates a sync-request event given a sender peer",
      "func": "create.execute",
      "tests": [
        {
          "given": {
            "db": {},
            "params": {
              "sender": "peer1"
            }
          },
          "then": {
            "return": {
              "return": "Sync request created",
              "newEvents": [
                {
                  "type": "sync_peers",
                  "sender": "peer1"
                }
              ]
            }
          }
        }
      ]
    },
    "send": {
      "description": "Sends a sync-request to a recipient peer via outgoing",
      "func": "send.execute",
      "tests": [
        {
          "given": {
            "db": {
              "state": {}
            },
            "params": {
              "recipient": "peer2"
            }
          },
          "then": {
            "return": {
              "return": "Sync request sent to peer2"
            },
            "db": {
              "state": {
                "outgoing": [
                  {
                    "recipient": "peer2",
                    "data": {
                      "type": "sync_peers",
                      "sender": "*"
                    }
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "sync_all": {
      "description": "Sends sync requests from all identities to all their known peers",
      "func": "sync_all.execute",
      "tests": [
        {
          "given": {
            "db": {
              "state": {
                "identities": [
                  {
                    "pubkey": "id1",
                    "privkey": "id1_priv",
                    "name": "Identity1"
                  },
                  {
                    "pubkey": "id2",
                    "privkey": "id2_priv",
                    "name": "Identity2"
                  }
                ],
                "peers": [
                  {
                    "pubkey": "peer1",
                    "name": "Peer1",
                    "received_by": "id1"
                  },
                  {
                    "pubkey": "peer2",
                    "name": "Peer2",
                    "received_by": "id1"
                  },
                  {
                    "pubkey": "peer1",
                    "name": "Peer1",
                    "received_by": "id2"
                  },
                  {
                    "pubkey": "peer2",
                    "name": "Peer2",
                    "received_by": "id2"
                  }
                ]
              }
            },
            "params": {}
          },
          "then": {
            "return": {
              "return": "Sent sync requests from 2 identities to 2 peers"
            },
            "db": {
              "state": {
                "identities": [
                  {
                    "pubkey": "id1",
                    "privkey": "id1_priv",
                    "name": "Identity1"
                  },
                  {
                    "pubkey": "id2",
                    "privkey": "id2_priv",
                    "name": "Identity2"
                  }
                ],
                "peers": [
                  {
                    "pubkey": "peer1",
                    "name": "Peer1",
                    "received_by": "id1"
                  },
                  {
                    "pubkey": "peer2",
                    "name": "Peer2",
                    "received_by": "id1"
                  },
                  {
                    "pubkey": "peer1",
                    "name": "Peer1",
                    "received_by": "id2"
                  },
                  {
                    "pubkey": "peer2",
                    "name": "Peer2",
                    "received_by": "id2"
                  }
                ],
                "outgoing": [
                  {
                    "recipient": "peer1",
                    "data": {
                      "type": "sync_peers",
                      "sender": "id1"
                    }
                  },
                  {
                    "recipient": "peer2",
                    "data": {
                      "type": "sync_peers",
                      "sender": "id1"
                    }
                  },
                  {
                    "recipient": "peer1",
                    "data": {
                      "type": "sync_peers",
                      "sender": "id2"
                    }
                  },
                  {
                    "recipient": "peer2",
                    "data": {
                      "type": "sync_peers",
                      "sender": "id2"
                    }
                  }
                ]
              }
            }
          }
        }
      ]
    }
  },
  "job": "sync_all"
}
