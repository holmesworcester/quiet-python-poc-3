{
  "type": "message",
  "projector": {
    "description": "Validates sig using metadata, adds to state.messages if valid; if selfGenerated, encrypts and adds to outgoing.",
    "func": "projector.project",
    "tests": [
      {
        "given": {
          "db": {"state": {"messages": []}},
          "envelope": {
            "data": {"type": "message", "text": "Hello", "sig": "abc"},
            "metadata": {"selfGenerated": true, "outerKeyHash": "X"}
          }
        },
        "then": {
          "db": {
            "state": {"messages": [{"text": "Hello"}]},
            "outgoing": ["encrypted_payload"]
          }
        }
      },
      {
        "given": {
          "db": {"state": {"known_senders": ["sender1"], "messages": []}},
          "envelope": {
            "data": {"type": "message", "text": "World", "sender": "sender1", "sig": "def"},
            "metadata": {"eventId": "event123"}
          }
        },
        "then": {
          "db": {
            "eventStore": {"sender1": [{"type": "message", "text": "World", "sender": "sender1", "sig": "def"}]},
            "state": {"messages": [{"text": "World", "sender": "sender1", "sig": "def", "id": "event123"}]}
          }
        }
      },
      {
        "given": {
          "db": {"state": {"known_senders": [], "messages": []}},
          "envelope": {
            "data": {"type": "message", "text": "Unknown", "sender": "unknown_sender"},
            "metadata": {}
          }
        },
        "then": {
          "db": {
            "eventStore": {"unknown_sender": [{"type": "message", "text": "Unknown", "sender": "unknown_sender"}]},
            "state": {"messages": []}
          }
        }
      },
      {
        "description": "Self-generated message with recipient should land in state.outgoing and preserve recipient",
        "given": {
          "db": { "state": { "messages": [], "outgoing": [] } },
          "envelope": {
            "data": { "type": "message", "text": "Hello", "sender": "peerA", "recipient": "peerB", "sig": "abc" },
            "metadata": { "selfGenerated": true }
          }
        },
        "then": {
          "db": {
            "state": {
              "messages": [ { "text": "Hello", "sender": "peerA", "recipient": "peerB", "timestamp": "*" } ],
              "outgoing": [
                {
                  "recipient": "peerB",
                  "data": {
                    "type": "message",
                    "text": "Hello",
                    "sender": "peerA",
                    "recipient": "peerB",
                    "sig": "abc"
                  }
                }
              ]
            }
          }
        }
      },
      {
        "description": "Projector should preserve recipient on stored messages (with known sender)",
        "given": {
          "db": { "state": { "messages": [], "known_senders": ["peerA"] } },
          "envelope": {
            "data": { "type": "message", "text": "Hi", "sender": "peerA", "recipient": "peerB", "sig": "def" },
            "metadata": {}
          }
        },
        "then": {
          "db": {
            "state": {
              "messages": [ { "text": "Hi", "sender": "peerA", "recipient": "peerB", "timestamp": "*" } ]
            }
          }
        }
      },
      {
        "description": "Projector should ignore messages lacking text/content (with known sender)",
        "given": {
          "db": { "state": { "messages": [], "known_senders": ["peerA"] } },
          "envelope": {
            "data": { "type": "message", "sender": "peerA" },
            "metadata": {}
          }
        },
        "then": {
          "db": {
            "state": { "messages": [] }
          }
        }
      },
      {
        "description": "Projector should not add to outgoing for non-self-generated messages (with known sender)",
        "given": {
          "db": { "state": { "messages": [], "outgoing": [], "known_senders": ["peerA"] } },
          "envelope": {
            "data": { "type": "message", "text": "External", "sender": "peerA", "recipient": "peerB", "sig": "xyz" },
            "metadata": { "selfGenerated": false }
          }
        },
        "then": {
          "db": {
            "state": {
              "messages": [ { "text": "External", "sender": "peerA", "recipient": "peerB", "timestamp": "*" } ],
              "outgoing": []
            }
          }
        }
      }
    ]
  },
  "commands": {
    "create": {
      "description": "Creates canonical signed event; puts in outgoing if recipient specified.",
      "func": "create.execute",
      "tests": [
        {
          "given": {"db": {}, "params": {"text": "Hello"}},
          "then": {"return": {"return": "Created", "newEvents": [{"type": "message", "text": "Hello", "sig": "*"}]}}
        },
        {
          "given": {"db": {}, "params": {"text": "Reply", "replyTo": "msg-123"}},
          "then": {"return": {"return": "Created", "newEvents": [{"type": "message", "text": "Reply", "replyTo": "msg-123", "sig": "*"}]}}
        },
        {
          "given": {"db": {"state": {}}, "params": {"text": "Hello peer", "recipient": "peer123"}},
          "then": {
            "return": {"return": "Message sent to outgoing", "newEvents": [{"type": "message", "text": "Hello peer", "recipient": "peer123", "sig": "*"}]},
            "db": {
              "state": {
                "outgoing": [
                  {
                    "recipient": "peer123",
                    "data": {"type": "message", "text": "Hello peer", "recipient": "peer123", "sig": "*"}
                  }
                ]
              }
            }
          }
        },
        {
          "description": "Message sent to recipient is delivered after ticks", 
          "given": {
            "db": {
              "state": {
                "identities": {
                  "alice": {
                    "keypair": {
                      "public": "alice_pub",
                      "private": "alice_priv"
                    }
                  }
                },
                "known_senders": ["alice_pub"],
                "messages": []
              }
            },
            "params": {
              "text": "Hello via ticks",
              "recipient": "bob_pub",
              "time_now_ms": 1000
            },
            "identity": "alice"
          },
          "ticks": 2,
          "then": {
            "return": {
              "return": "Message sent to outgoing"
            },
            "db": {
              "state": {
                "messages": [{
                  "text": "Hello via ticks",
                  "sender": "*",
                  "recipient": "bob_pub"
                }],
                "outgoing": []
              }
            }
          }
        }
      ]
    },
    "list": {
      "description": "Lists all messages for a given peer",
      "func": "list.execute",
      "tests": [
        {
          "given": {
            "db": {
              "state": {
                "messages": [
                  {"text": "Hi", "sender": "peer1", "recipient": "peer2", "timestamp": 100},
                  {"text": "Hello", "sender": "peer2", "recipient": "peer1", "timestamp": 200}
                ]
              }
            },
            "params": {"peer_pubkey": "peer1"}
          },
          "then": {
            "return": {
              "return": "Found 2 messages",
              "messages": [
                {"text": "Hi", "sender": "peer1", "recipient": "peer2", "timestamp": 100},
                {"text": "Hello", "sender": "peer2", "recipient": "peer1", "timestamp": 200}
              ]
            }
          }
        }
      ]
    }
  }
}